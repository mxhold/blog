<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <title>Build a Blog with Phoenix and Ember.js - Max Holder</title>

      <link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700|Merriweather:400,300,300italic,700,700italic,400italic" rel="stylesheet" type="text/css">
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
      <link href="/stylesheets/all-4b31baeb.css" rel="stylesheet" type="text/css" />
      <script src="/javascripts/all-da39a3ee.js" type="text/javascript"></script>
  </head>

  <body class="blog blog_build-a-blog-with-phoenix-and-ember blog_build-a-blog-with-phoenix-and-ember_index">
      <nav class="global-nav">
    <a href="/">Home</a>
  </nav>
  <article class="blog-post">
    <header class="blog-header">
      <h1 class="blog-title">Build a Blog with Phoenix and Ember.js</h1>
      <time class="publish-date" datetime="2015-06-04 12:24 UTC">
        Jun 4, 2015
      </time>
    </header>
    <div style="border: 1px solid red; background-color: pink; width: 60%;
      margin: auto; padding: 5px">
      This post is <strong>outdated</strong>.<br>In current versions, these
      exact steps will be incorrect.
</div>

<h2 id="moving-beyond-rails">Moving beyond Rails</h2>

<p>A lot of new frameworks have emerged in the last couple of years aimed at making web applications easier to build.</p>

<p><a href="http://rubyonrails.org/">Ruby on Rails</a> emerged in 2005 and has grown incredibly popular as an all-inclusive framework for making web applications.</p>

<p>Rails offered a massive boost in productivity by focusing on convention over configuration with sane defaults.</p>

<p>Since then, a countless number of JavaScript frameworks and libraries have been released, leading to a shared experience by many web developers of <a href="http://brewhouse.io/blog/2015/05/13/emberjs-an-antidote-to-your-hype-fatigue.html"><em>JavaScript Framework Fatigue</em></a>.</p>

<p>Rails continues to be a useful tool for making web apps, but falls short of offering the level of interactivity that others have sought from Single Page Application frameworks like <a href="http://emberjs.com">Ember.js</a>.</p>

<p>Using Rails as the backend API for a Ember.js app is certainly a viable option, but <a href="http://phoenixframework.org">Phoenix</a> is becoming a more and more worthy competitor every day by offering features like <a href="http://www.phoenixframework.org/v0.13.1/docs/channels">Channels</a> using WebSockets. Phoenix is not even 1.0 yet, but is already <a href="https://www.youtube.com/watch?v=oMlX9i9Icno&amp;t=1h9m">inspiring</a> features in Rails.</p>

<h2 id="the-peep-stack">The PEEP Stack</h2>

<p>More and more applications are sure to be written in the <a href="https://medium.com/@j_mcnally/the-peep-stack-b7ba5afdd055">PEEP stack</a>:</p>

<p>The <strong>Phoenix</strong> framework, written in <a href="http://elixir-lang.org"><strong>Elixir</strong></a>, can leverage the mature (and fast) Erlang VM to provide fault-tolerant systems while still maintaining the same level of expressiveness (and developer productivity) as a language like Ruby.</p>

<p><strong>Ember.js</strong> offers stability amidst the ever-changing landscape of JS frontend frameworks. It attempts to establish conventions on the frontend like Rails did before while <a href="https://github.com/emberjs/ember.js/pull/10501">happily borrowing</a> good ideas from other frameworks, all to make building highly interactive applications much easier.</p>

<p><strong>PostgreSQL</strong> is an excellent database system and happens to be the most well-supported by <a href="https://github.com/elixir-lang/ecto">Ecto</a>, the Elixir database wrapper used in Phoenix.</p>

<h2 id="building-a-blog-app">Building a blog app</h2>

<p>This blog post will walk you through the steps necessary to create a simple blog application using Phoenix on the backend with Ember.js on the frontend.</p>

<p>It won’t use any of the cool stuff like Phoenix Channels, but it should serve as an example of how to make a very basic <abbr title="Create/Read/Update/Destroy">CRUD</abbr> app.</p>

<p>At the end, you should be able to create, view, edit, and delete blog posts.</p>

<p>If you want to see the final product, both apps are available on GitHub (<a href="https://github.com/mxhold/peep_blog_backend">Phoenix app</a>, <a href="https://github.com/mxhold/peep-blog-frontend">Ember app</a>) and deployed to Heroku (<a href="https://peep-blog-backend.herokuapp.com/">Phoenix app</a>, <a href="https://peep-blog-frontend.herokuapp.com/">Ember app</a>).</p>

<p>Here’s what we’ll cover:</p>

<ul>
  <li><a href="#installing-everything">Installing everything you need for Elixir/Phoenix/Ember.js</a></li>
  <li><a href="#building-a-simple-json-api-using-phoenix">Building a simple JSON API using Phoenix</a></li>
  <li><a href="#creating-a-single-page-frontend-app-using-emberjs">Creating a single-page frontend app using Ember.js</a></li>
  <li><a href="#deploying-to-heroku">Deploying both apps to Heroku</a></li>
</ul>

<h2 id="installing-everything">Installing everything</h2>

<p>For this section, the commands I include assume you are running on OS X and have <a href="http://brew.sh/">Homebrew</a> installed, but I will also include links for other operating systems.</p>

<p>For the deployment section, I’ll also assume you have <a href="http://git-scm.org">Git</a> installed and already have a <a href="http://heroku.com">Heroku</a> account with the <a href="https://toolbelt.heroku.com/">Heroku Toolbelt</a> installed.</p>

<p>The version numbers I include below are what they were when I wrote this post. They are likely already a little bit behind if you pull in the latest releases. Everything should still work as long as the versions are not too far off.</p>

<h3 id="elixirerlang">Elixir/Erlang</h3>

<p>First, let’s install the Elixir programming language along with Erlang.</p>

<p>OS X with Homebrew (others see: the Elixir <a href="http://elixir-lang.org/install.html">install guide</a>):</p>

<pre class="highlight shell"><code>brew update <span class="o">&amp;&amp;</span> brew install elixir
</code></pre>

<p>Verify it worked:</p>

<pre class="highlight shell"><code>elixir --version
<span class="c"># should output:</span>
Elixir 1.1.1
</code></pre>

<h3 id="phoenix">Phoenix</h3>

<p>Now we’ll install the Phoenix framework.</p>

<p>First, we need to install <a href="http://hex.pm">Hex</a>, the Erlang package manager:</p>

<pre class="highlight shell"><code>mix local.hex
</code></pre>

<p>Then, we can install Phoenix:</p>

<pre class="highlight shell"><code>mix archive.install https://github.com/phoenixframework/phoenix/releases/download/v1.0.3/phoenix_new-1.0.3.ez
</code></pre>

<p>Verify it worked:</p>

<pre class="highlight shell"><code>mix --help | grep phoenix.new
<span class="c"># should output:</span>
mix phoenix.new         <span class="c"># Create a new Phoenix v1.0.3 application</span>
</code></pre>

<h3 id="postgresql">PostgreSQL</h3>

<p>For OS X, I suggest using <a href="http://postgresapp.com">Postgres.app</a>.</p>

<p>Other operating systems: see the PostgreSQL <a href="http://www.postgresql.org/download/">download page</a> or the <a href="https://wiki.postgresql.org/wiki/Detailed_installation_guides">detailed installation guides</a>.</p>

<p>Whichever way you end up installing Postgres, make sure:</p>

<ul>
  <li>
    <p>The <code>psql</code> binary is in your <code>$PATH</code></p>

    <p>If you installed Postgres.app, you will need to add the following to your <code>.bashrc</code> file or similar:</p>

<pre class="highlight shell"><code><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/Applications/Postgres.app/Contents/Versions/9.4/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
</code></pre>
  </li>
  <li>
    <p>You have a <code>postgres</code> superuser role without a password or with “postgres” as the password</p>

    <p>If you installed Postgres.app, you can create the role with:</p>

<pre class="highlight sql"><code><span class="n">psql</span> <span class="o">-</span><span class="k">c</span> <span class="nv">"CREATE ROLE postgres WITH SUPERUSER LOGIN;"</span>
</code></pre>

    <p>A <code>postgres</code> role isn’t required, but if you choose not to do this, be sure to edit your <code>config/dev.exs</code> file once you create your Phoenix app to match whatever credentials you do use.</p>
  </li>
</ul>

<p>You can verify this all worked by running:</p>

<pre class="highlight shell"><code>psql -U postgres -c <span class="s2">"select 1+1;"</span>
<span class="c"># should output:</span>
 ?column?
----------
        2
<span class="o">(</span>1 row<span class="o">)</span>

</code></pre>

<h3 id="nodejsnpm">Node.js/NPM</h3>

<p>Now we need to install Node.js so we can install the Ember CLI tool.</p>

<p>On OS X with Homebrew (other OS see: Node.js <a href="https://nodejs.org/download/">download page</a>):</p>

<pre class="highlight shell"><code>brew install node
</code></pre>

<p>Verify it worked:</p>

<pre class="highlight shell"><code>node --version
<span class="c"># should output:</span>
v0.12.4

npm --version
<span class="c"># should output:</span>
2.10.1
</code></pre>

<h3 id="watchman">Watchman</h3>

<p>Ember CLI uses Watchman as a more efficient way to watch for changes on the filesystem.</p>

<p>On OS X:</p>

<pre class="highlight shell"><code>brew install watchman
</code></pre>

<p>Windows: skip this step because Watchman is not supported on Windows.</p>

<p>Other UNIX-like OS: see Watchman <a href="https://facebook.github.io/watchman/docs/install.html">installation docs</a>.</p>

<p>Verify it worked:</p>

<pre class="highlight shell"><code>watchman --version
<span class="c"># should output:</span>
3.1.0
</code></pre>

<h3 id="ember-cliemberjs">Ember CLI/Ember.js</h3>

<p>Now we’ll install the Ember CLI tool:</p>

<pre class="highlight shell"><code>npm install -g ember-cli
</code></pre>

<p>We’ll also install Bower to manage the frontend packages:</p>

<pre class="highlight shell"><code>npm install -g bower
</code></pre>

<p>Verify all this worked:</p>

<pre class="highlight shell"><code>ember --version
<span class="c"># should output:</span>
version: 0.2.7
node: 0.12.4
npm: 2.11.0

bower --version
<span class="c"># should output:</span>
1.4.1
</code></pre>

<p>You probably also will want to install the <a href="https://github.com/emberjs/ember-inspector">Ember inspector</a> for your browser as it is extremely helpful for debugging.</p>

<h2 id="project-setup">Project setup</h2>

<p>There are many ways to organize separate frontend and backend apps.</p>

<p>Since we’re not going to share any code between the two, we’ll put them in separate directories as separate git repositories nested under one main project directory:</p>

<pre class="highlight plaintext"><code>peep_blog
├── peep-blog-frontend (Ember.js project)
└── peep_blog_backend (Phoenix project)
</code></pre>

<p>Note: Ember.js apps are conventionally named with dashes whereas Phoenix app names should be in snake case.</p>

<p>So let’s start by making the main project directory and generating a new Phoenix app:</p>

<pre class="highlight shell"><code>mkdir peep_blog
<span class="nb">cd </span>peep_blog/
mix phoenix.new peep_blog_backend
<span class="c"># When it prompts "Fetch and install dependencies? [Yn]", hit enter.</span>
</code></pre>

<p>We can verify that worked by moving to the Phoenix project directory and starting up the server:</p>

<pre class="highlight shell"><code><span class="nb">cd </span>peep_blog_backend/
mix phoenix.server
<span class="c"># should output a bunch of lines like:</span>
Compiled blahblahblah
<span class="c"># ...</span>
<span class="c"># and then finally:</span>
<span class="o">[</span>info] Running PeepBlogBackend.Endpoint with Cowboy on port 4000 <span class="o">(</span>http<span class="o">)</span>
</code></pre>

<p>You should then be able to hit <a href="http://localhost:4000">http://localhost:4000</a> and see the Phoenix welcome page.</p>

<p>Hit <code>Ctrl-C</code> twice to stop the server.</p>

<h2 id="building-a-simple-json-api-using-phoenix">Building a simple JSON API using Phoenix</h2>

<p>Our goal here is to make an API that our Ember app can use to manage blog posts.</p>

<p>It should support the following HTTP calls:</p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Path</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>POST</td>
      <td>/posts</td>
      <td>create a new post</td>
    </tr>
    <tr>
      <td>GET</td>
      <td>/posts</td>
      <td>list all posts</td>
    </tr>
    <tr>
      <td>GET</td>
      <td>/posts/:id</td>
      <td>show a single post</td>
    </tr>
    <tr>
      <td>PUT</td>
      <td>/posts/:id</td>
      <td>update a post</td>
    </tr>
    <tr>
      <td>DELETE</td>
      <td>/posts/:id</td>
      <td>remove a post</td>
    </tr>
    <tr>
      <td>OPTIONS</td>
      <td>/posts*</td>
      <td>provide headers for CORS</td>
    </tr>
  </tbody>
</table>

<p>We can do most of this with Phoenix’s <a href="https://github.com/phoenixframework/phoenix/blob/v0.13.1/lib/mix/tasks/phoenix.gen.json.ex">JSON generator</a> by running:</p>

<pre class="highlight shell"><code>mix phoenix.gen.json Post posts title:string body:text
</code></pre>

<p>This is very similar to the generators for Rails, except you’ll notice that Phoenix does not try to guess the plural form for the table name.</p>

<p>Now we need to update the router for our new resource.</p>

<p>Edit <code>web/router.ex</code> and replace the contents with:</p>

<pre class="highlight elixir"><code><span class="k">defmodule</span> <span class="no">PeepBlogBackend</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PeepBlogBackend</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:router</span>

  <span class="n">pipeline</span> <span class="ss">:api</span> <span class="k">do</span>
    <span class="n">plug</span> <span class="ss">:accepts</span><span class="p">,</span> <span class="p">[</span><span class="sd">"</span><span class="s2">json"</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">scope</span> <span class="sd">"</span><span class="s2">/"</span><span class="p">,</span> <span class="no">PeepBlogBackend</span> <span class="k">do</span>
    <span class="n">pipe_through</span> <span class="ss">:api</span>

    <span class="n">resources</span> <span class="sd">"</span><span class="s2">/posts"</span><span class="p">,</span> <span class="no">PostController</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This adds our new resource and removes the HTML stuff we don’t need.
Before we can run the migration to create this new table, we’ll need to setup our database:</p>

<pre class="highlight shell"><code>mix ecto.create
<span class="c"># should output:</span>
The database <span class="k">for </span>PeepBlogBackend.Repo has been created.
</code></pre>

<p>Then we can run the migration to create the <code>posts</code> table:</p>

<pre class="highlight shell"><code>mix ecto.migrate
<span class="c"># should output:</span>
<span class="o">[</span>info] <span class="o">==</span> Running PeepBlogBackend.Repo.Migrations.CreatePost.change/0 forward
<span class="o">[</span>info] create table posts
<span class="o">[</span>info] <span class="o">==</span> Migrated <span class="k">in </span>0.0s
</code></pre>

<p>Now we should be able to test it!</p>

<p>Start the server with <code>mix phoenix.server</code> in another terminal tab and then send a request with <a href="http://curl.haxx.se/">cURL</a>:</p>

<pre class="highlight shell"><code>curl -H <span class="s2">"Content-Type: application/json"</span> http://localhost:4000/posts
<span class="c"># should output:</span>
<span class="o">{</span><span class="s2">"data"</span>:[]<span class="o">}</span>

curl -X POST -H <span class="s2">"Content-Type: application/json"</span> -d <span class="s1">'{ "post": { "title": "Test title", "body": "Lorem ipsum" } }'</span> http://localhost:4000/posts
<span class="c"># should output:</span>
<span class="o">{</span><span class="s2">"data"</span>:<span class="o">{</span><span class="s2">"id"</span>:1<span class="o">}}</span>

curl -H <span class="s2">"Content-Type: application/json"</span> http://localhost:4000/posts/1
<span class="c"># should output:</span>
<span class="o">{</span><span class="s2">"data"</span>:<span class="o">{</span><span class="s2">"title"</span>:<span class="s2">"Test title"</span>,<span class="s2">"id"</span>:1,<span class="s2">"body"</span>:<span class="s2">"Lorem ipsum"</span><span class="o">}}</span>
</code></pre>

<p>Woo!</p>

<p>We now have a backend that should be sufficient to get starting making our Ember.js app.</p>

<p>Keep your Phoenix server running in another terminal tab while we work on the Ember app.</p>

<h2 id="creating-a-single-page-frontend-app-using-emberjs">Creating a single-page frontend app using Ember.js</h2>

<p>First, we’ll generate new Ember app, install the dependencies and start it up:</p>

<pre class="highlight shell"><code><span class="nb">cd</span> ../
<span class="c"># we should be in the main peep_blog directory now</span>
ember new peep-blog-frontend
<span class="nb">cd </span>peep-blog-frontend/
npm install <span class="o">&amp;&amp;</span> bower install
ember server
</code></pre>

<p>With that running, we should be able to hit <a href="http://localhost:4200/">http://localhost:4200/</a> and see “Welcome to Ember.js”.</p>

<p>You can press <code>Ctrl-C</code> to stop the server, but I suggest keeping it running in another terminal.</p>

<p>Now we need to make the frontend pages to do CRUD actions on our Post resource.</p>

<h3 id="index-page">Index page</h3>

<p>We’ll start with the <code>/posts</code> route.</p>

<p>Ember CLI also has generators to make this easier. Run:</p>

<pre class="highlight shell"><code>ember generate resource posts title:string body:string
</code></pre>

<p>So we should be able to hit <a href="http://localhost:4200/">http://localhost:4200/</a> without any errors, but it will still just show “Welcome to Ember.js”.</p>

<p>To get it to show the example post that we created before, we’ll need to setup the route.</p>

<p>Change <code>app/routes/posts.js</code> to:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">model</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'post'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Now when you visit <a href="http://localhost:4200/posts">http://localhost:4200/posts</a> you’ll get several errors (make sure to have your browser’s JavaScript console open when you load the page to see them), the first being:</p>

<pre class="highlight plaintext"><code>GET http://localhost:4200/posts 404 (Not Found)
</code></pre>

<p>This is Ember trying to hit our backend API and failing, which is not too surprising because our Phoenix server is not running on <code>localhost:4200</code>, it is at <code>localhost:4000</code>!</p>

<p>We need to tell Ember to look at <code>localhost:4000</code> for all the API calls.</p>

<p>We can do this by creating a new file at <code>app/adapters/application.js</code> with these contents:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">DS</span> <span class="nx">from</span> <span class="s2">"ember-data"</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">RESTAdapter</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">host</span><span class="p">:</span> <span class="s1">'http://localhost:4000'</span>
<span class="p">});</span>
</code></pre>

<p>This configures Ember Data to use the <a href="http://guides.emberjs.com/v1.12.0/models/the-rest-adapter/">RESTAdapter</a> and to hit our Phoenix server at <a href="http://localhost:4000">http://localhost:4000</a> for loading all our models.</p>

<h4 id="content-security-policy">Content Security Policy</h4>

<p>Now when we load <a href="http://localhost:4200/posts">http://localhost:4200/posts</a> we get a different error:</p>

<pre class="highlight plaintext"><code>Refused to connect to 'http://localhost:4000/posts' because it violates the following Content Security Policy directive: "connect-src 'self' ws://localhost:35729 ws://0.0.0.0:35729 http://0.0.0.0:4200/csp-report"
</code></pre>

<p>If you’re unfamiliar with what “Content Security Policy” means, the Mozilla Development Network provides <a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP">a good overview</a>.</p>

<p>Basically, this is because Ember CLI, by default, includes <a href="https://github.com/rwjblue/ember-cli-content-security-policy">an addon</a> that sets a <code>Content-Security-Policy-Report-Only</code> header on responses to the development server.</p>

<p>Your browser sees this header and spits out an error when we try to make a request to any origin other than the server’s origin (http://localhost:4200).</p>

<p>Since the header is report only, the request still works but displays this error to remind us that we haven’t set everything up correctly.</p>

<p>We need to tell Ember that it is ok to load data from our Phoenix app since it is not from the same origin (same host but different port) as the Ember app.</p>

<p>We can do this by editing <code>config/environment.js</code> and changing:</p>

<pre class="highlight javascript"><code>  <span class="k">if</span> <span class="p">(</span><span class="nx">environment</span> <span class="o">===</span> <span class="s1">'development'</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
</code></pre>

<p>to:</p>

<pre class="highlight javascript"><code><span class="k">if</span> <span class="p">(</span><span class="nx">environment</span> <span class="o">===</span> <span class="s1">'development'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ENV</span><span class="p">.</span><span class="nx">contentSecurityPolicy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default-src'</span><span class="p">:</span> <span class="s2">"'none'"</span><span class="p">,</span>
    <span class="s1">'script-src'</span><span class="p">:</span> <span class="s2">"'self'"</span><span class="p">,</span>
    <span class="s1">'font-src'</span><span class="p">:</span> <span class="s2">"'self'"</span><span class="p">,</span>
    <span class="s1">'connect-src'</span><span class="p">:</span> <span class="s2">"'self' http://localhost:4000"</span><span class="p">,</span>
    <span class="s1">'img-src'</span><span class="p">:</span> <span class="s2">"'self'"</span><span class="p">,</span>
    <span class="s1">'style-src'</span><span class="p">:</span> <span class="s2">"'self'"</span><span class="p">,</span>
    <span class="s1">'media-src'</span><span class="p">:</span> <span class="s2">"'self'"</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>

<p>Note that this is only relevant to the development environment since we won’t be using Ember CLI to serve our app on production.</p>

<p>Once we deploy our app, we’ll have to configure our server to set its own CSP header. This addon is just to keep us thinking about CSP so we don’t forget to set it up.</p>

<p>We want to have it all set up right so that if someone manages to inject some JS on your site, this prevents their script from being able to connect to some random server.</p>

<h4 id="cross-origin-resource-sharing">Cross-Origin Resource Sharing</h4>

<p>Now when we load <a href="http://localhost:4200/posts">http://localhost:4200/posts</a> we get yet another error:</p>

<pre class="highlight plaintext"><code>XMLHttpRequest cannot load http://localhost:4000/posts. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://localhost:4200' is therefore not allowed access.
</code></pre>

<p>This is again because we’re attempting to make calls to a server on a different origin, except now it’s a problem with how our Phoenix server is setup.</p>

<p>Again, MDN describes in detail how <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">Cross-Origin Resource Sharing</a> works.</p>

<p>Your browser is now willing to make the call to the Phoenix server (since we relaxed the CSP headers above), but when it receives the response, it checks the headers for this <code>Access-Control-Allow-Origin</code> header, which we are not sending.</p>

<p>As the name implies, this header lets the server specify which origins should be able to load this resource.</p>

<p>We need to send this header from our Phoenix app. Fortunately, there is a library (<a href="https://github.com/whatyouhide/corsica">Corsica</a>) for doing just that.</p>

<p>Switch to your Phoenix project directory, stop the Phoenix server, and edit your <code>mix.exs</code> file to add the dependency:</p>

<pre class="highlight elixir"><code><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="p">{</span><span class="ss">:corsica</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.4"</span><span class="p">}</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre>

<p>Then pull in your dependencies:</p>

<pre class="highlight shell"><code>mix deps.get
<span class="c"># should output:</span>
Running dependency resolution
Dependency resolution completed successfully
  corsica: v0.4.0
<span class="k">*</span> Getting corsica <span class="o">(</span>Hex package<span class="o">)</span>
</code></pre>

<p>Now edit <code>lib/peep_blog_backend/endpoint.ex</code> and add the Corsica plug before the Router plug near the bottom of the file:</p>

<pre class="highlight elixir"><code><span class="n">plug</span> <span class="no">Corsica</span><span class="p">,</span> <span class="p">[</span><span class="ss">origins:</span> <span class="p">[</span><span class="sd">"</span><span class="s2">http://localhost:4200"</span><span class="p">]]</span>
<span class="n">plug</span> <span class="no">PeepBlogBackend</span><span class="o">.</span><span class="no">Router</span>
</code></pre>

<p>Now start your Phoenix server back up with <code>mix phoenix.server</code> and try to hit <a href="http://localhost:4200/posts">http://localhost:4200/posts</a> again.</p>

<p>Now we get a cryptic error but a helpful warning before it:</p>

<pre class="highlight plaintext"><code>WARNING: Encountered "data" in payload, but no model was found for model name "datum" (resolved model name using peep-blog-frontend@serializer:-rest:.typeForRoot("data"))
</code></pre>

<p>This is Ember’s REST serializer complaining that the root of the JSON we’re loading is <code>data</code>, so it is trying to find a <code>datum</code> model, which doesn’t exist.</p>

<p><a href="http://guides.emberjs.com/v1.12.0/models/the-rest-adapter/#toc_json-root">The documentation</a> tells us the root needs to be <code>posts</code> in this case.</p>

<p>Note: I wouldn’t be surprised to see this may change in the future as the <a href="http://jsonapi.org/">JSON API</a> spec that Ember co-creator Yehuda Katz is co-writing uses <code>data</code> as the root element.</p>

<p>We can change this easily enough by editing <code>web/views/post_view.ex</code> to change:</p>

<pre class="highlight elixir"><code><span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">index.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">posts:</span> <span class="n">posts</span><span class="p">})</span> <span class="k">do</span>
  <span class="p">%{</span><span class="ss">data:</span> <span class="n">render_many</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="sd">"</span><span class="s2">post.json"</span><span class="p">)}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">show.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">post:</span> <span class="n">post</span><span class="p">})</span> <span class="k">do</span>
  <span class="p">%{</span><span class="ss">data:</span> <span class="n">render_one</span><span class="p">(</span><span class="n">post</span><span class="p">,</span> <span class="sd">"</span><span class="s2">post.json"</span><span class="p">)}</span>
<span class="k">end</span>
</code></pre>

<p>to:</p>

<pre class="highlight elixir"><code><span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">index.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">posts:</span> <span class="n">posts</span><span class="p">})</span> <span class="k">do</span>
  <span class="p">%{</span><span class="ss">posts:</span> <span class="n">render_many</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="sd">"</span><span class="s2">post.json"</span><span class="p">)}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="sd">"</span><span class="s2">show.json"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">post:</span> <span class="n">post</span><span class="p">})</span> <span class="k">do</span>
  <span class="p">%{</span><span class="ss">post:</span> <span class="n">render_one</span><span class="p">(</span><span class="n">post</span><span class="p">,</span> <span class="sd">"</span><span class="s2">post.json"</span><span class="p">)}</span>
<span class="k">end</span>
</code></pre>

<p>Now we can try <a href="http://localhost:4200/posts">http://localhost:4200/posts</a> again.</p>

<p>The page will still just say “Welcome to Ember.js” but we shouldn’t have any errors anymore. Yay!</p>

<p>If you have the Ember inspector installed, you should be able to navigate to <code>Data &gt; post (1)</code> and see the post we created earlier with all its attributes.</p>

<p>Now we need to change the templates to show this data that we are now loading.</p>

<p>Switch back to your Ember project and edit <code>app/templates/posts.hbs</code> to be:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span>Posts<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="k">{{#</span><span class="nn">each</span> <span class="nv">post</span> <span class="nv">in</span> <span class="nv">model</span><span class="k">}}</span>
  <span class="nt">&lt;li&gt;</span>
    <span class="k">{{</span><span class="nv">post</span><span class="p">.</span><span class="nv">title</span><span class="k">}}</span>
  <span class="nt">&lt;/li&gt;</span>
  <span class="k">{{/</span><span class="nn">each</span><span class="k">}}</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="k">{{</span><span class="nv">outlet</span><span class="k">}}</span>
</code></pre>

<p>Now when we hit <a href="http://localhost:4200/posts">http://localhost:4200/posts</a> we should see our “Test title” post we created earlier.</p>

<p>We’ve successfully handled the Post index route!</p>

<h3 id="show-page">Show page</h3>

<p>Now let’s add a route for the individual posts.</p>

<p>First, we need to edit <code>app/router.js</code> from:</p>

<pre class="highlight javascript"><code><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p>to:</p>

<pre class="highlight javascript"><code><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/:post_id'</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>

<p>Then we need to add a new file at <code>app/routes/posts/post.js</code> with the contents:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">model</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">post_id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Then we have to add a new template at <code>app/templates/posts/post.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span><span class="k">{{</span><span class="nv">model</span><span class="p">.</span><span class="nv">title</span><span class="k">}}</span><span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;article&gt;</span>
  <span class="k">{{</span><span class="nv">model</span><span class="p">.</span><span class="nv">body</span><span class="k">}}</span>
<span class="nt">&lt;/article&gt;</span>

<span class="k">{{</span><span class="nv">outlet</span><span class="k">}}</span>
</code></pre>

<p>Finally, let’s add a link to this new route from the Post index page by editing <code>app/templates/posts.hbs</code> to be:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span>Posts<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="k">{{#</span><span class="nn">each</span> <span class="nv">post</span> <span class="nv">in</span> <span class="nv">model</span><span class="k">}}</span>
  <span class="nt">&lt;li&gt;</span>
    <span class="k">{{#</span><span class="nn">link-to</span> <span class="s1">'posts.post'</span> <span class="nv">post</span><span class="k">}}</span>
      <span class="k">{{</span><span class="nv">post</span><span class="p">.</span><span class="nv">title</span><span class="k">}}</span>
    <span class="k">{{/</span><span class="nn">link-to</span><span class="k">}}</span>
  <span class="nt">&lt;/li&gt;</span>
  <span class="k">{{/</span><span class="nn">each</span><span class="k">}}</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="k">{{</span><span class="nv">outlet</span><span class="k">}}</span>
</code></pre>

<p>Now you should be able to click on “Test title” and go to <a href="http://localhost:4200/posts/1">http://localhost:4200/posts/1</a> and see the body of the post we created before.</p>

<h2 id="new-page">New page</h2>

<p>Now we’ll make a page where you can create new posts.</p>

<p>Like before, first we’ll edit the <code>app/router.js</code> file to now contain:</p>

<pre class="highlight javascript"><code><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'new'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/:post_id'</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>

<p>We need to add a new route at <code>app/routes/posts/new.js</code>:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">model</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">createRecord</span><span class="p">(</span><span class="s1">'post'</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">save</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentModel</span><span class="p">;</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Then we’ll add a new template at <code>app/templates/posts/new.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span>New Post<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"title"</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;&lt;br&gt;</span>
  <span class="k">{{</span><span class="nv">input</span> <span class="nv">value</span><span class="o">=</span><span class="nv">model</span><span class="p">.</span><span class="nv">title</span> <span class="nv">id</span><span class="o">=</span><span class="s2">"title"</span><span class="k">}}</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"body"</span><span class="nt">&gt;</span>Body<span class="nt">&lt;/label&gt;&lt;br&gt;</span>
  <span class="k">{{</span><span class="nv">textarea</span> <span class="nv">value</span><span class="o">=</span><span class="nv">model</span><span class="p">.</span><span class="nv">body</span> <span class="nv">id</span><span class="o">=</span><span class="s2">"body"</span><span class="k">}}</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;button</span> <span class="k">{{</span><span class="nv">action</span> <span class="s1">'save'</span><span class="k">}}</span> <span class="na">id=</span><span class="s">"save"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
</code></pre>

<p>Finally, we’ll add a link to our new page by editing <code>app/templates/posts.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="k">{{</span><span class="nv">link-to</span> <span class="s1">'New post'</span> <span class="s1">'posts.new'</span><span class="k">}}</span>

<span class="nt">&lt;h2&gt;</span>Posts<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="k">{{#</span><span class="nn">each</span> <span class="nv">post</span> <span class="nv">in</span> <span class="nv">model</span><span class="k">}}</span>
  <span class="nt">&lt;li&gt;</span>
    <span class="k">{{#</span><span class="nn">link-to</span> <span class="s1">'posts.post'</span> <span class="nv">post</span><span class="p">.</span><span class="nv">id</span><span class="k">}}</span>
      <span class="k">{{</span><span class="nv">post</span><span class="p">.</span><span class="nv">title</span><span class="k">}}</span>
    <span class="k">{{/</span><span class="nn">link-to</span><span class="k">}}</span>
  <span class="nt">&lt;/li&gt;</span>
  <span class="k">{{/</span><span class="nn">each</span><span class="k">}}</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="k">{{</span><span class="nv">outlet</span><span class="k">}}</span>
</code></pre>

<p>Now we should be able to click “New post” from our <code>/posts</code> page and be taken to a form.</p>

<p>Fill in some values (and delight in the two-way data binding we get for free!) and click the “Save” button.</p>

<p>Whomp whomp. A new error!</p>

<h4 id="pre-flight-options">Pre-flight OPTIONS</h4>

<p>Our Ember app is attempting to make a request to <code>http://localhost:4000/posts</code> with the <code>OPTIONS</code> HTTP method but is getting a 404 Not Found error.</p>

<p>This is related to the CORS stuff we did before.</p>

<p>The browser sends this preflight request to make sure the server knows about CORS, checking for the <code>Access-Control-Allow-Origin</code> header we set above.</p>

<p>We have the headers set right, but we need to have our Phoenix server respond to OPTIONS requests.</p>

<p>To do this, switch to your Phoenix project and edit <code>lib/peep_blog_backend/endpoint.ex</code> we are adding the allow_headers to our Corsica plug:</p>

<pre class="highlight elixir"><code><span class="n">plug</span> <span class="no">Corsica</span><span class="p">,</span> <span class="p">[</span><span class="ss">origins:</span> <span class="p">[</span><span class="sd">"</span><span class="s2">http://localhost:4200"</span><span class="p">],</span> <span class="ss">allow_headers:</span> <span class="p">[</span><span class="sd">"</span><span class="s2">accept"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">content-type"</span><span class="p">]]</span>
<span class="n">plug</span> <span class="no">PeepBlogBackend</span><span class="o">.</span><span class="no">Router</span>
</code></pre>

<p>Try to submit the new post form again and this time it should work!</p>

<h3 id="edit-page">Edit page</h3>

<p>Switching back to the Ember app, now let’s make it so you can edit a post after it has been created.</p>

<p>Edit <code>app/router.js</code> to include:</p>

<pre class="highlight javascript"><code><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'new'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/:post_id'</span> <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'edit'</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>

<p>We need to add a route at <code>app/routes/posts/post/edit.js</code>:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">save</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentModel</span><span class="p">;</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'posts.post'</span><span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Note: if you’ve never seen the above <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">fat arrow syntax</a>, it is a part of <a href="https://people.mozilla.org/~jorendorff/es6-draft.html">ES6</a> that Ember CLI will transpile into ES5 thanks to the <a href="https://github.com/babel/ember-cli-babel">Babel</a> library. The above would be equivalent to:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">save</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentModel</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'posts.post'</span><span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>We need to add a template. Instead of duplicating what is in the <code>new</code> template, we can extract the form into a partial and render it on both pages.</p>

<p>Make a new file at <code>app/templates/posts/_form.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"title"</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;&lt;br&gt;</span>
  <span class="k">{{</span><span class="nv">input</span> <span class="nv">value</span><span class="o">=</span><span class="nv">model</span><span class="p">.</span><span class="nv">title</span> <span class="nv">id</span><span class="o">=</span><span class="s2">"title"</span><span class="k">}}</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"body"</span><span class="nt">&gt;</span>Body<span class="nt">&lt;/label&gt;&lt;br&gt;</span>
  <span class="k">{{</span><span class="nv">textarea</span> <span class="nv">value</span><span class="o">=</span><span class="nv">model</span><span class="p">.</span><span class="nv">body</span> <span class="nv">id</span><span class="o">=</span><span class="s2">"body"</span><span class="k">}}</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;button</span> <span class="k">{{</span><span class="nv">action</span> <span class="s1">'save'</span><span class="k">}}</span> <span class="na">id=</span><span class="s">"save"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
</code></pre>

<p>Change <code>app/templates/posts/new.hbs</code> to:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span>New Post<span class="nt">&lt;/h2&gt;</span>

<span class="k">{{</span><span class="nv">partial</span> <span class="s2">"posts/form"</span><span class="k">}}</span>
</code></pre>

<p>And add <code>app/templates/posts/post/edit.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span>Edit Post<span class="nt">&lt;/h2&gt;</span>

<span class="k">{{</span><span class="nv">partial</span> <span class="s2">"posts/form"</span><span class="k">}}</span>
</code></pre>

<p>Finally, add a link on the show page for the edit page by editing <code>app/templates/posts/post.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span><span class="k">{{</span><span class="nv">model</span><span class="p">.</span><span class="nv">title</span><span class="k">}}</span><span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;article&gt;</span>
  <span class="k">{{</span><span class="nv">model</span><span class="p">.</span><span class="nv">body</span><span class="k">}}</span>
<span class="nt">&lt;/article&gt;</span>

<span class="k">{{#</span><span class="nn">link-to</span> <span class="s1">'posts.post.edit'</span> <span class="nv">model</span><span class="k">}}</span>Edit<span class="k">{{/</span><span class="nn">link-to</span><span class="k">}}</span>

<span class="k">{{</span><span class="nv">outlet</span><span class="k">}}</span>
</code></pre>

<p>Now try editing a post.</p>

<p>Your changes should be persisted even when you refresh the page.</p>

<h3 id="deleting-a-post">Deleting a post</h3>

<p>Finally, we need to be able to delete posts.</p>

<p>Edit <code>app/routes/posts/post.js</code>:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">model</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'post'</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">post_id</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">delete</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentModel</span><span class="p">;</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">deleteRecord</span><span class="p">();</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Edit <code>app/templates/posts/post.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2&gt;</span><span class="k">{{</span><span class="nv">model</span><span class="p">.</span><span class="nv">title</span><span class="k">}}</span><span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;article&gt;</span>
  <span class="k">{{</span><span class="nv">model</span><span class="p">.</span><span class="nv">body</span><span class="k">}}</span>
<span class="nt">&lt;/article&gt;</span>

<span class="k">{{#</span><span class="nn">link-to</span> <span class="s1">'posts.post.edit'</span> <span class="nv">model</span><span class="k">}}</span>Edit<span class="k">{{/</span><span class="nn">link-to</span><span class="k">}}</span>

<span class="nt">&lt;button</span> <span class="k">{{</span><span class="nv">action</span> <span class="s2">"delete"</span><span class="k">}}</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/button&gt;</span>

<span class="k">{{</span><span class="nv">outlet</span><span class="k">}}</span>
</code></pre>

<h3 id="root-route">Root route</h3>

<p>One last thing: when we go to just <a href="http://localhost:4200">http://localhost:4200</a> we just see “Welcome to Ember.js” but it would be nice if it took us straight to the <code>/posts</code> route.</p>

<p>This is easy enough to change.</p>

<p>Ember will look for an <code>index</code> route when you hit <code>/</code>, so we just need to add a file at <code>app/routes/index.js</code> with:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">'ember'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">redirect</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Let’s also make the main header “Blog” instead of “Welcome to Ember.js!” by editing <code>app/templates/application.hbs</code>:</p>

<pre class="highlight handlebars"><code><span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"title"</span><span class="nt">&gt;</span>Blog<span class="nt">&lt;/h2&gt;</span>

<span class="k">{{</span><span class="nv">outlet</span><span class="k">}}</span>
</code></pre>

<p>That should do it for the Ember app!</p>

<h2 id="deploying-to-heroku">Deploying to Heroku</h2>

<p>Now let’s share our app with the world.</p>

<h3 id="deploying-the-phoenix-app">Deploying the Phoenix app</h3>

<p>Create a <code>Procfile</code> at the root of your Phoenix project with the following contents:</p>

<pre class="highlight plaintext"><code>web: mix phoenix.server
</code></pre>

<p>Then initialize a git repository and commit your code:</p>

<pre class="highlight shell"><code>git init
git add -A
git commit -m <span class="s2">"Initial commit"</span>
</code></pre>

<p>Create a new Heroku app, specifying the <a href="https://github.com/HashNuke/heroku-buildpack-elixir">Heroku buildpack for Elixir</a> and enable the Postgres addon:</p>

<pre class="highlight shell"><code>heroku create --buildpack <span class="s2">"https://github.com/HashNuke/heroku-buildpack-elixir.git"</span>
heroku addons:create heroku-postgresql
</code></pre>

<p>Edit your <code>config/prod.secret.exs</code> file to move settings into environment variables:</p>

<pre class="highlight elixir"><code><span class="kn">use</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Config</span>

<span class="c1"># In this file, we keep production configuration that</span>
<span class="c1"># you likely want to automate and keep it away from</span>
<span class="c1"># your version control system.</span>
<span class="n">config</span> <span class="ss">:peep_blog_backend</span><span class="p">,</span> <span class="no">PeepBlogBackend</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span>
  <span class="ss">secret_key_base:</span> <span class="no">System</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="sd">"</span><span class="s2">SECRET_KEY_BASE"</span><span class="p">)</span>

<span class="c1"># Configure your database</span>
<span class="n">config</span> <span class="ss">:peep_blog_backend</span><span class="p">,</span> <span class="no">PeepBlogBackend</span><span class="o">.</span><span class="no">Repo</span><span class="p">,</span>
  <span class="ss">adapter:</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Postgres</span><span class="p">,</span>
  <span class="ss">url:</span> <span class="no">System</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="sd">"</span><span class="s2">DATABASE_URL"</span><span class="p">)</span> <span class="o">||</span> <span class="sd">"</span><span class="s2">ecto://postgres:postgres@localhost/blog_backend_prod"</span><span class="p">,</span>
  <span class="ss">size:</span> <span class="m">20</span> <span class="c1"># The amount of database connections in the pool</span>
</code></pre>

<p>Now that this file contains no actual secrets, edit your <code>.gitignore</code> and comment the last line:</p>

<pre class="highlight shell"><code><span class="c"># /config/prod.secret.exs</span>
</code></pre>

<p>Then generate and set the environment variable for your secret key base:</p>

<pre class="highlight shell"><code>heroku config:set <span class="nv">SECRET_KEY_BASE</span><span class="o">=</span><span class="k">$(</span>elixir -e <span class="s2">":crypto.strong_rand_bytes(64) |&gt; Base.encode16(case: :lower) |&gt; IO.puts"</span><span class="k">)</span>
</code></pre>

<p>The <code>DATABASE_URL</code> environment variable should already be set from adding the Postgres addon.</p>

<p>We need to add a <code>elixir_buildpack.config</code> file at the root of the project with these contents (in order for the <code>SECRET_KEY_BASE</code> to get exported):</p>

<pre class="highlight shell"><code><span class="nv">config_vars_to_export</span><span class="o">=(</span>DATABASE_URL SECRET_KEY_BASE<span class="o">)</span>
</code></pre>

<p>Commit your changes and deploy:</p>

<pre class="highlight shell"><code>git add -A
git commit -m <span class="s2">"Extract config settings to env variables"</span>
git push heroku
</code></pre>

<p>Once that finishes, try going to the your app’s <code>/posts</code> path in your browser:</p>

<pre class="highlight shell"><code>open <span class="k">$(</span>heroku apps:info -s | grep web_url | cut -d<span class="s2">"="</span> -f2<span class="k">)</span><span class="s2">"posts"</span>
</code></pre>

<p>You should see <code>"Server internal error"</code>.</p>

<p>Why are we getting an error?</p>

<p>Let’s look at the logs by running <code>heroku logs</code>.</p>

<p>You should see something like:</p>

<pre class="highlight plaintext"><code>** (Postgrex.Error) ERROR (undefined_table): relation "posts" does not exist
</code></pre>

<p>We need to create the database on production:</p>

<pre class="highlight shell"><code>heroku run mix ecto.create
</code></pre>

<p>You may see an error like:</p>

<pre class="highlight plaintext"><code>** (Mix) The database for Todobackend.Repo couldn't be created, reason given: Error: You must install at least one postgresql-client-&lt;version&gt; package.
</code></pre>

<p>You can ignore this.</p>

<p>Then run the migrations:</p>

<pre class="highlight shell"><code>heroku run mix ecto.migrate
<span class="c"># should output something like:</span>
17:12:41.365 <span class="o">[</span>info] <span class="o">==</span> Running PeepBlogBackend.Repo.Migrations.CreatePost.change/0 forward
17:12:41.366 <span class="o">[</span>info] create table posts
17:12:41.399 <span class="o">[</span>info] <span class="o">==</span> Migrated <span class="k">in </span>0.3s
</code></pre>

<p>Now try to hit your app’s <code>/posts</code> route again and you should get:</p>

<pre class="highlight json"><code><span class="p">{</span><span class="s2">"posts"</span><span class="p">:[]}</span><span class="w">
</span></code></pre>

<p>That’s it for the Phoenix app!</p>

<h3 id="deploying-the-ember-app">Deploying the Ember app</h3>

<p>Commit your current code:</p>

<pre class="highlight shell"><code><span class="nb">cd</span> ../peep-blog-frontend/
git add -A
git commit -m <span class="s2">"Initial commit"</span>
</code></pre>

<p>Create another Heroku app using the <a href="https://github.com/tonycoco/heroku-buildpack-ember-cli">Ember CLI buildpack</a>:</p>

<pre class="highlight shell"><code>heroku create --buildpack https://github.com/tonycoco/heroku-buildpack-ember-cli.git
</code></pre>

<p>Edit your <code>app/adapters/application.js</code> file to extract the API server URL to an config variable:</p>

<pre class="highlight javascript"><code><span class="kr">import</span> <span class="nx">DS</span> <span class="nx">from</span> <span class="s2">"ember-data"</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">ENV</span> <span class="nx">from</span> <span class="s1">'../config/environment'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">RESTAdapter</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">host</span><span class="p">:</span> <span class="nx">ENV</span><span class="p">.</span><span class="nx">APP</span><span class="p">.</span><span class="nx">API_URL</span>
<span class="p">});</span>
</code></pre>

<p>Then define that in your <code>config/environment.js</code> file:</p>

<pre class="highlight javascript"><code><span class="k">if</span> <span class="p">(</span><span class="nx">environment</span> <span class="o">===</span> <span class="s1">'development'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ENV</span><span class="p">.</span><span class="nx">APP</span><span class="p">.</span><span class="nx">API_URL</span> <span class="o">=</span> <span class="s1">'http://localhost:4000'</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">environment</span> <span class="o">===</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ENV</span><span class="p">.</span><span class="nx">APP</span><span class="p">.</span><span class="nx">API_URL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_URL</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</code></pre>

<p>Now set the environment variable on your Heroku app (replacing the URL with the path to your Phoenix app, <strong>without</strong> a trailing slash):</p>

<pre class="highlight shell"><code>heroku config:set <span class="nv">API_URL</span><span class="o">=</span>https://your-phoenix-app.herokuapp.com
</code></pre>

<p>Now deploy your app:</p>

<pre class="highlight shell"><code>git add -A
git commit -m <span class="s2">"Extract API URL environment variable"</span>
git push heroku
</code></pre>

<p>Go to your <code>/posts/new</code> route and try to create a new post:</p>

<pre class="highlight shell"><code>open <span class="k">$(</span>heroku apps:info -s | grep web_url | cut -d<span class="s2">"="</span> -f2<span class="k">)</span><span class="s2">"posts/new"</span>
</code></pre>

<p>You should see our old friend the CORS error:</p>

<pre class="highlight plaintext"><code>XMLHttpRequest cannot load https://your-phoenix-app.herokuapp.com/posts. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'https://your-ember-app.herokuapp.com' is therefore not allowed access. The response had HTTP status code 403.
</code></pre>

<p>Switch to your Phoenix project directory:</p>

<pre class="highlight shell"><code><span class="nb">cd</span> ../peep_blog_backend
</code></pre>

<p>We need to change <code>web/router.ex</code> to get the frontend URL from an environment variable. Change:</p>

<pre class="highlight elixir"><code><span class="n">plug</span> <span class="no">PlugCors</span><span class="p">,</span> <span class="p">[</span><span class="ss">origins:</span> <span class="p">[</span><span class="sd">"</span><span class="s2">localhost:4200"</span><span class="p">]]</span>
</code></pre>

<p>to:</p>

<pre class="highlight elixir"><code><span class="n">plug</span> <span class="no">PlugCors</span><span class="p">,</span> <span class="p">[</span><span class="ss">origins:</span> <span class="p">[</span><span class="no">System</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="sd">"</span><span class="s2">FRONTEND_URL"</span><span class="p">)]]</span>
</code></pre>

<p>and edit your <code>elixir_buildpack.config</code> file:</p>

<pre class="highlight shell"><code><span class="nv">config_vars_to_export</span><span class="o">=(</span>DATABASE_URL SECRET_KEY_BASE FRONTEND_URL<span class="o">)</span>
</code></pre>

<p>Set the environment variable to your Ember app URL (without the scheme) and deploy your Phoenix app again:</p>

<pre class="highlight shell"><code>heroku config:set <span class="nv">FRONTEND_URL</span><span class="o">=</span>your-ember-app.herokuapp.com
git add -A
git commit -m <span class="s2">"Extract frontend URL environment variable"</span>
git push heroku
</code></pre>

<p>Now you should be able to use the entire app without any errors!</p>

<h2 id="one-last-csp-fix">One last CSP fix</h2>

<p>Everything works but if you inspect the requests from the Ember app, you’ll notice the lack of the CSP headers we saw in development.</p>

<p>This is because the Ember buildpack does not set any of these headers in the Nginx config it provides.</p>

<p>The Ember buildback also takes a different approach for getting past CORS by setting up a <a href="http://oskarhane.com/avoid-cors-with-nginx-proxy_pass/">proxy_pass</a>, which we don’t need since we’ve explicitly added our Ember origin to the headers in our Phoenix app.</p>

<p>We can override the buildpack’s Nginx configuration by copying it and making some changes:</p>

<pre class="highlight shell"><code>wget https://raw.githubusercontent.com/tonycoco/heroku-buildpack-ember-cli/master/config/nginx.conf.erb
mv nginx.conf.erb config/
</code></pre>

<p>Then edit <code>config/nginx.conf.erb</code> and replace this section:</p>

<pre class="highlight erb"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"API_URL"</span><span class="p">]</span> <span class="cp">%&gt;</span>
  location <span class="cp">&lt;%=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"API_PREFIX_PATH"</span><span class="p">]</span> <span class="o">||</span> <span class="s2">"/api/"</span> <span class="cp">%&gt;</span> {
    proxy_pass <span class="cp">&lt;%=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"API_URL"</span><span class="p">]</span> <span class="cp">%&gt;</span>;
    proxy_set_header Real-IP $remote_addr;
    proxy_set_header Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header NginX-Proxy true;
    proxy_ssl_session_reuse off;
    proxy_redirect off;
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"NGINX_DEBUG"</span><span class="p">]</span> <span class="cp">%&gt;</span>add_header Ember-Cli-Proxy on;<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  }
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>

<p>with:</p>

<pre class="highlight erb"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"API_URL"</span><span class="p">]</span> <span class="cp">%&gt;</span>
  add_header Content-Security-Policy "default-src 'none'; script-src 'self'; font-src 'self'; connect-src 'self' <span class="cp">&lt;%=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"API_URL"</span><span class="p">]</span> <span class="cp">%&gt;</span>; img-src 'self'; style-src 'self'; media-src 'self'";
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>

<p>Now deploy your Ember app one last time and it should include the correct CSP headers.</p>

<h2 id="done">Done!</h2>

<p>Phew, that sure did seem like a lot for something that Rails can do with a single generator command!</p>

<p>I would definitely say if all you need is a simple CRUD app, the PEEP stack is overkill.</p>

<p>But hopefully this post has provided a good starting point for getting to know both Phoenix and Ember.js.</p>

  </article>
  <div class="subscribe-container">
    <div class="subscribe">
      <form action="https://tinyletter.com/maxholder" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/maxholder', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
        <h1>
          Like this?
        </h1>
        <p>
          Get notified when I post in the future:
        </p>
          <input type="text" style="width:140px" name="email" id="tlemail" placeholder="you@example.com" />
        <input type="hidden" value="1" name="embed"/>
        <input type="submit" value="Subscribe" />
      </form>
    </div>
  </div>
  <footer class="blog-footer">
    <div class="author-photo">
    </div>
    <div class="author-info">
      <span class="author-name">
        Max Holder
      </span>
      <ul>
        <li>
          <a href="mailto:mxhold@gmail.com">
            <i class="fa fa-envelope"></i>
            mxhold@gmail.com
          </a>
        </li>
        <li>
          <a href="http://twitter.com/maxholder">
            <i class="fa fa-twitter"></i>
            @maxholder
          </a>
        </li>
        <li>
          <a href="http://github.com/mxhold">
            <i class="fa fa-github-alt"></i>
            mxhold
          </a>
        </li>
      </ul>
    </div>
  </footer>
  <div class="copyright">
    <p>
      © 2015 Max Holder
    </p>
    <p>
      This work is available under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY</a> license.
    </p>
  </div>

  </body>
</html>
